# HAProxy Configuration - Load Balancer for Multiple Tor Instances
# Provides random distribution across 4 Tor SOCKS proxies

global
log stdout format raw local0 info
maxconn 4096
user haproxy
group haproxy
daemon

# Performance tuning
tune.maxrewrite 1024
tune.bufsize 16384

defaults
log     global
mode    tcp
option  tcplog
option  dontlognull
timeout connect 10s
timeout client  30s
timeout server  30s
timeout queue   30s
retries 3

# Statistics page (optional, useful for monitoring)
listen stats
bind *:9090
mode http
stats enable
stats uri /stats
stats refresh 10s
stats show-legends
stats show-node

# Frontend - Accepts connections on port 9999
frontend tor_frontend
bind *:9999
mode tcp
default_backend tor_backends

# Connection limits
maxconn 2048

# Backend - Random load balancing across 4 Tor instances
backend tor_backends
mode tcp
balance random      # Random selection for anti-timing attacks

# Health checks (check if Tor SOCKS proxy responds)
option tcp-check
tcp-check connect port 9050

# Tor instance 1
server tor1 127.0.0.1:9050 check inter 30s fall 3 rise 2

# Tor instance 2
server tor2 127.0.0.1:9051 check inter 30s fall 3 rise 2

# Tor instance 3
server tor3 127.0.0.1:9052 check inter 30s fall 3 rise 2

# Tor instance 4
server tor4 127.0.0.1:9053 check inter 30s fall 3 rise 2

# Alternative: Round-robin backend (uncomment if you prefer predictable rotation)
# backend tor_backends
#     mode tcp
#     balance roundrobin
#     server tor1 127.0.0.1:9050 check
#     server tor2 127.0.0.1:9051 check
#     server tor3 127.0.0.1:9052 check
#     server tor4 127.0.0.1:9053 check
